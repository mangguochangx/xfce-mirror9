APPNAME=xfpanel-switch
PREFIX=@prefix@
PYTHON=`which @python@`
LANGUAGE_FILES=$(patsubst po/%.po, locale/%/LC_MESSAGES/$(APPNAME).mo, $(wildcard po/*.po))
DESTDIR=

all: $(LANGUAGE_FILES) layouts
	intltool-merge -d po xfpanel-switch.desktop.in xfpanel-switch.desktop
	intltool-merge -x po data/metainfo/org.xubuntu.XfpanelSwitch.appdata.xml.in \
		data/metainfo/org.xubuntu.XfpanelSwitch.appdata.xml
	chmod +x xfpanel-switch.desktop
	sed -e s,%prefix%,$(PREFIX), bin/$(APPNAME).in.in > bin/$(APPNAME).in
	sed -e s,%python%,$(PYTHON), bin/$(APPNAME).in > bin/$(APPNAME)
	chmod +x bin/$(APPNAME)

locale/%/LC_MESSAGES/$(APPNAME).mo: po/%.po
	mkdir -p $(dir $@)
	msgfmt $< -o $@

pot:
	cd po; intltool-update --pot --gettext-package=xfpanel-switch

layouts:
	cd data/layouts/gnome2; tar -cvjf "../GNOME 2.tar.bz2" *
	cd data/layouts/redmond; tar -cvjf "../Redmond.tar.bz2" *
	cd data/layouts/xfce-4.12; tar -cvjf "../Xfce 4.12.tar.bz2" *
	cd data/layouts/xubuntu-precise; tar -cvjf "../Xubuntu Precise.tar.bz2" *
	cd data/layouts/xubuntu-trusty; tar -cvjf "../Xubuntu Trusty.tar.bz2" *
	cd data/layouts/xubuntu-bionic; tar -cvjf "../Xubuntu Bionic.tar.bz2" *

install: all
	install -d $(DESTDIR)/$(PREFIX)/bin
	install bin/$(APPNAME) $(DESTDIR)/$(PREFIX)/bin

	install -d $(DESTDIR)/$(PREFIX)/share/$(APPNAME)/xfpanel-switch
	install xfpanel-switch/panelconfig.py $(DESTDIR)/$(PREFIX)/share/$(APPNAME)/xfpanel-switch
	install xfpanel-switch/xfpanel-switch.py $(DESTDIR)/$(PREFIX)/share/$(APPNAME)/xfpanel-switch
	install xfpanel-switch/xfpanel-switch.glade $(DESTDIR)/$(PREFIX)/share/$(APPNAME)/xfpanel-switch

	install -d $(DESTDIR)/$(PREFIX)/share/doc/$(APPNAME)
	install AUTHORS $(DESTDIR)/$(PREFIX)/share/doc/$(APPNAME)
	install COPYING $(DESTDIR)/$(PREFIX)/share/doc/$(APPNAME)
	install NEWS $(DESTDIR)/$(PREFIX)/share/doc/$(APPNAME)
	install INSTALL $(DESTDIR)/$(PREFIX)/share/doc/$(APPNAME)
	install README $(DESTDIR)/$(PREFIX)/share/doc/$(APPNAME)

	install -d $(DESTDIR)/$(PREFIX)/share/applications
	install -m 644 $(APPNAME).desktop $(DESTDIR)/$(PREFIX)/share/applications

	install -d $(DESTDIR)/$(PREFIX)/share/xfpanel-switch
	install -d $(DESTDIR)/$(PREFIX)/share/xfpanel-switch/layouts
	install data/layouts/*.tar.bz2 $(DESTDIR)/$(PREFIX)/share/xfpanel-switch/layouts

	install -d $(DESTDIR)/$(PREFIX)/share/metainfo
	install data/metainfo/*.xml $(DESTDIR)/$(PREFIX)/share/metainfo

	cp -rf locale $(DESTDIR)/$(PREFIX)/share
	ln -sf $(PREFIX)/share/locale $(DESTDIR)/$(PREFIX)/share/$(APPNAME)/locale

uninstall:
	rm -f $(DESTDIR)/$(PREFIX)/share/applications/$(APPNAME).desktop
	rm -rf $(DESTDIR)/$(PREFIX)/share/$(APPNAME)
	rm -rf $(DESTDIR)/$(PREFIX)/share/doc/$(APPNAME)
	# FIXME: Uninstall locales
	rm -f $(DESTDIR)/$(PREFIX)/bin/$(APPNAME)

clean:
	rm -Rf locale
	rm -f xfpanel-switch/*.pyc
	rm -f bin/$(APPNAME).in
	rm -f bin/$(APPNAME)
	rm -f data/layouts/*.tar.bz2
	rm -f xfpanel-switch.desktop
	rm -f Makefile.in
	rm -f Makefile
